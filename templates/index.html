<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apex Journey Optimizer</title>
    
    <script src="https://js.api.here.com/v3/3.1/mapsjs-core.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-service.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-ui.js"></script>
    <script src="https://js.api.here.com/v3/3.1/mapsjs-mapevents.js"></script>
    <link rel="stylesheet" href="https://js.api.here.com/v3/3.1/mapsjs-ui.css" />

    <style>
        /* --- 1. THEME & RESET --- */
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap');
        
        :root {
            --primary: #6366f1;
            --bg-page: #fdfdfd;
            --bg-input: #eef2ff;
            --text-main: #1e293b;
            --text-muted: #94a3b8;
            --success: #166534;
        }

        * { box-sizing: border-box; font-family: 'Outfit', sans-serif; }
        body { margin: 0; background: var(--bg-page); color: var(--text-main); padding: 40px 20px; text-align: center; }
        .container { max-width: 800px; margin: 0 auto; }

        /* --- 2. INPUT SECTION (PLANNER CARD) --- */
        .planner-card { 
            background: #fff; padding: 35px; border-radius: 24px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; 
            margin-bottom: 25px; 
        }

        .input-row { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; }
        .field-group { flex: 1; text-align: left; }
        label { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; display: block; margin-bottom: 8px; }
        
        input { 
            width: 100%; padding: 14px 18px; border-radius: 12px; 
            border: none; background: var(--bg-input); font-size: 1rem; font-weight: 500; 
        }

        .swap-btn { 
            background: none; border: none; color: var(--primary); 
            font-size: 1.5rem; cursor: pointer; padding-top: 20px; 
        }

        /* --- 3. MODE SELECTOR --- */
        .mode-container { display: flex; justify-content: center; gap: 12px; margin-bottom: 25px; }
        .mode-btn { 
            padding: 12px 22px; border-radius: 12px; border: none; 
            background: #f1f5f9; cursor: pointer; font-weight: 600; color: #475569; 
        }
        .mode-btn.active { background: var(--primary); color: #fff; }

        .search-btn { 
            width: 100%; padding: 18px; border-radius: 14px; 
            background: #1e293b; color: #fff; border: none; 
            font-size: 1rem; font-weight: 700; cursor: pointer; 
        }

        /* --- 4. RESULTS & DATA DISPLAY --- */
        #results-area { display: none; }
        .recommendation-banner { 
            background: #f0fdf4; color: var(--success); padding: 15px; 
            border-radius: 14px; font-weight: 700; margin-bottom: 20px; 
            border-left: 5px solid #22c55e; text-align: left;
        }

        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #fff; padding: 25px 15px; border-radius: 20px; border: 1px solid #f1f5f9; }
        .stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; display: block; }
        .stat-value { font-size: 1.4rem; font-weight: 700; color: var(--primary); display: block; margin: 6px 0; }
        
        .weather-strip { 
            background: #eff6ff; padding: 15px; border-radius: 14px; 
            display: flex; justify-content: center; gap: 40px; 
            font-size: 0.9rem; margin-bottom: 20px; color: #1e40af; 
        }

        /* --- 5. MAP PREVIEW --- */
        #map-box { height: 400px; border-radius: 20px; border: 1px solid #f1f5f9; overflow: hidden; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Apex Journey Optimizer</h1>
    </div>

    <div class="planner-card">
        <div class="input-row">
            <div class="field-group">
                <label>Origin</label>
                <input id="origin" placeholder="e.g. Kolkata">
            </div>
            <button class="swap-btn" onclick="swapLocations()">‚áÑ</button>
            <div class="field-group">
                <label>Destination</label>
                <input id="destination" placeholder="e.g. Delhi">
            </div>
        </div>

        <div class="mode-container">
            <button class="mode-btn active" onclick="changeTransportMode(this,'road')">üöó Road</button>
            <button class="mode-btn" onclick="changeTransportMode(this,'train')">üöÜ Train</button>
            <button class="mode-btn" onclick="changeTransportMode(this,'flight')">‚úà Flight</button>
        </div>

        <button class="search-btn" onclick="performOptimization()">Optimize My Journey</button>
    </div>

    <div id="results-area">
        <div class="recommendation-banner" id="rec-message"></div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-label">Total Distance</span>
                <span class="stat-value" id="val-distance">0</span>km
            </div>
            <div class="stat-card">
                <span class="stat-label">Travel Time</span>
                <span class="stat-value" id="val-time">0h 0m</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Est. Cost</span>
                <span class="stat-value" id="val-cost">‚Çπ0</span>
            </div>
        </div>

        <div class="weather-strip">
            <span>üìç Origin: <b id="weather-origin">--</b></span>
            <span>üèÅ Dest: <b id="weather-dest">--</b></span>
        </div>

        <div id="map-box"></div>
    </div>
</div>

<script>
    /* --- LOGIC LAYER: GLOBAL VARIABLES --- */
    let activeMode = "road";
    let dataCache = null;
    let mapInstance = null;
    let routeGroup = null;

    const platform = new H.service.Platform({ apikey: "{{ here_api_key }}" });

    /* --- UI HANDLERS --- */
    function swapLocations() {
        const o = document.getElementById("origin");
        const d = document.getElementById("destination");
        [o.value, d.value] = [d.value, o.value];
    }

    function changeTransportMode(btn, m) {
        activeMode = m;
        document.querySelectorAll(".mode-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        if(dataCache) renderData();
    }

    /* --- DATA ORCHESTRATION --- */
    function performOptimization() {
        const o = document.getElementById("origin").value.trim();
        const d = document.getElementById("destination").value.trim();
        if(!o || !d) return alert("Please enter locations.");

        fetch(`/route?origin=${encodeURIComponent(o)}&destination=${encodeURIComponent(d)}`)
            .then(res => res.json())
            .then(data => {
                if(data.error) return alert(data.error);
                dataCache = data;
                document.getElementById("results-area").style.display = "block";
                renderData();
            });
    }

/* --- DATA ORCHESTRATION --- */
    function renderData() {
      const km = dataCache.distance;
      let time, cost, rec = "";
    
      // Multi-Mode Logic Calculations
      const c_road = km * 5.5, c_train = km * 1.8, c_flight = km * 4.5;
      const t_road = dataCache.road_time, t_train = km * 0.6, t_flight = (km / 700) * 60 + 120;

      if(activeMode === "road") { time = t_road; cost = c_road; }
      else if(activeMode === "train") { time = t_train; cost = c_train; }
      else { time = t_flight; cost = c_flight; }

      // --- UPDATED SMART LOGIC: Cheapest vs Fastest ---
    
      // 1. Check for the Fastest Option (Usually Flight for long distances)
      const times = [
        { mode: 'Road', val: t_road },
        { mode: 'Train', val: t_train },
        { mode: 'Flight', val: t_flight }
      ];
      const fastest = times.reduce((prev, curr) => prev.val < curr.val ? prev : curr);

      // 2. Check for the Cheapest Option
      const costs = [
        { mode: 'Road', val: c_road },
        { mode: 'Train', val: c_train },
        { mode: 'Flight', val: c_flight }
      ];
      const cheapest = costs.reduce((prev, curr) => prev.val < curr.val ? prev : curr);

      // 3. Generate Recommendation Message
      if (activeMode === fastest.mode.toLowerCase()) {
        rec = `‚ö° Fastest Route: ${fastest.mode} is the quickest way to reach your destination!`;
      } else if (activeMode === cheapest.mode.toLowerCase()) {
        rec = `üí∞ Budget Friendly: ${cheapest.mode} is the most cost-effective option!`;
      } else {
        rec = `‚ÑπÔ∏è Note: ${fastest.mode} is faster, while ${cheapest.mode} would save you money.`;
      }
      // DOM Updates
      document.getElementById("val-distance").innerText = km;
      document.getElementById("val-time").innerText = `${Math.floor(time/60)}h ${Math.round(time%60)}m`;
      document.getElementById("val-cost").innerText = "‚Çπ" + cost.toFixed(2);
      document.getElementById("weather-origin").innerText = dataCache.origin_weather;
      document.getElementById("weather-dest").innerText = dataCache.dest_weather;
      document.getElementById("rec-message").innerText = rec;

      initializeMap();
    }

    /* --- MAP VISUALIZATION LAYER --- */
    function initializeMap() {
        if(!mapInstance) {
            const layers = platform.createDefaultLayers();
            mapInstance = new H.Map(document.getElementById("map-box"), layers.vector.normal.map, {zoom:5, center:{lat:20, lng:78}});
            new H.mapevents.Behavior(new H.mapevents.MapEvents(mapInstance));
            routeGroup = new H.map.Group(); 
            mapInstance.addObject(routeGroup);
        }
        
        routeGroup.removeAll();
        const start = {lat:dataCache.o_lat, lng:dataCache.o_lng};
        const end = {lat:dataCache.d_lat, lng:dataCache.d_lng};
        routeGroup.addObjects([new H.map.Marker(start), new H.map.Marker(end)]);

        if(activeMode === "road") {
            const line = H.geo.LineString.fromFlexiblePolyline(dataCache.polyline);
            routeGroup.addObject(new H.map.Polyline(line, {style:{strokeColor:'#6366f1', lineWidth:5}}));
        } else {
            const ls = new H.geo.LineString(); ls.pushPoint(start); ls.pushPoint(end);
            routeGroup.addObject(new H.map.Polyline(ls, {style:{strokeColor:'#6366f1', lineWidth:4, lineDash:[5,5]}}));
        }
        mapInstance.getViewModel().setLookAtData({bounds:routeGroup.getBoundingBox(), padding:50});
    }
</script>
</body>
</html>